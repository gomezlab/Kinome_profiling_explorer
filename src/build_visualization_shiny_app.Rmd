```{r setup}
library(shiny)
library(here)
library(data.table)
library(fst)
library(ggplot2)
```

```{r load-data}
data_path <- here("results/combined_kd_data_summarized.fst")
dt <- as.data.table(read_fst(data_path))[
  , .(target, compound = compound_pubchem_cid, kd_apparent = mean_kd_apparent)
]
```

```{r ui}
ui <- fluidPage(
  titlePanel("Kinase Drug Interactions Visualization"),
  tabsetPanel(
    tabPanel("Drug to Target",
      sidebarLayout(
        sidebarPanel(
          selectizeInput(
            "selectedDrug", "Choose a Drug:",
            choices = NULL,
            options = list(placeholder = "Type to search…")
          ),
          numericInput("kdThresholdDrug", "Kd Threshold (nM):", 1000)
        ),
        mainPanel(
          plotOutput("barGraphDrug")
        )
      )
    ),
    tabPanel("Target to Drug",
      sidebarLayout(
        sidebarPanel(
          selectizeInput(
            "selectedTarget", "Choose a Target:",
            choices = NULL,
            options = list(placeholder = "Type to search…")
          ),
          numericInput("kdThresholdTarget", "Kd Threshold (nM):", 1000)
        ),
        mainPanel(
          plotOutput("barGraphTarget")
        )
      )
    )
  )
)
```

```{r server}
server <- function(input, output, session) {
  # Populate selectize inputs server-side for better performance
  updateSelectizeInput(
    session, "selectedDrug",
    choices = unique(dt$compound),
    server = TRUE
  )
  updateSelectizeInput(
    session, "selectedTarget",
    choices = unique(dt$target),
    server = TRUE
  )

  # Reactive filtered data based on inputs
  filteredDrug <- reactive({
    req(input$selectedDrug)
    dt[
      compound == input$selectedDrug & kd_apparent < input$kdThresholdDrug
    ][order(-kd_apparent)]
  })

  filteredTarget <- reactive({
    req(input$selectedTarget)
    dt[
      target == input$selectedTarget & kd_apparent < input$kdThresholdTarget
    ][order(-kd_apparent)]
  })

  # Drug -> Target bar plot with caching
  output$barGraphDrug <- renderPlot({
    data <- filteredDrug()
    if (nrow(data) == 0) {
      plot.new()
      text(0.5, 0.5, "No data available for the selected criteria.")
    } else {
      data[, target := factor(target, levels = unique(target))]
      ggplot(data, aes(x = target, y = kd_apparent)) +
        geom_col() +
        coord_flip() +
        theme_minimal() +
        labs(
          x = "Target", y = "Kd (nM)",
          title = paste("Kd values for", input$selectedDrug)
        ) +
        theme(axis.text.x = element_text(angle = 45, hjust = 1))
    }
  }) %>% bindCache(input$selectedDrug, input$kdThresholdDrug)

  # Target -> Drug bar plot with caching
  output$barGraphTarget <- renderPlot({
    data <- filteredTarget()
    if (nrow(data) == 0) {
      plot.new()
      text(0.5, 0.5, "No data available for the selected criteria.")
    } else {
      data[, compound := factor(compound, levels = unique(compound))]
      ggplot(data, aes(x = compound, y = kd_apparent)) +
        geom_col() +
        coord_flip() +
        theme_minimal() +
        labs(
          x = "Compound", y = "Kd (nM)",
          title = paste("Drugs targeting", input$selectedTarget)
        ) +
        theme(axis.text.x = element_text(angle = 45, hjust = 1))
    }
  }) %>% bindCache(input$selectedTarget, input$kdThresholdTarget)
}

# Run the application
shinyApp(ui = ui, server = server)
```