```{r}
library(shiny)
library(here)
library(dplyr)
library(fst)
library(tidyHeatmap)
library(ggplot2)
```

```{r}
data_path <- here("results/combined_kd_data_summarized.fst")
combined_dataset_kinase_compound_info <- read_fst(data_path)  %>% 
    rename(kd_apparent = mean_kd_apparent, compound = compound_pubchem_cid)


# UI
ui <- fluidPage(
  titlePanel("Kinase Drug Interactions Visualization"),
  tabsetPanel(
    tabPanel("Drug to Target", 
             sidebarLayout(
               sidebarPanel(
                 selectInput("selectedDrug", "Choose a Drug:",
                             choices = unique(combined_dataset_kinase_compound_info$compound)),
                 numericInput("kdThresholdDrug", "Kd Threshold (nM):", 1000)
               ),
               mainPanel(
                 plotOutput("barGraphDrug")
               )
             )),
    tabPanel("Target to Drug",
             sidebarLayout(
               sidebarPanel(
                 selectInput("selectedTarget", "Choose a Target:",
                             choices = unique(combined_dataset_kinase_compound_info$target)),
                 numericInput("kdThresholdTarget", "Kd Threshold (nM):", 1000)
               ),
               mainPanel(
                 plotOutput("barGraphTarget")
               )
             ))
  )
)

# Server logic
server <- function(input, output) {
  # Bar graph for Drug to Target
  output$barGraphDrug <- renderPlot({
    filtered_data <- combined_dataset_kinase_compound_info %>%
      filter(compound == input$selectedDrug, kd_apparent < input$kdThresholdDrug) %>%
      arrange(desc(kd_apparent)) %>%
      mutate(target = factor(target, levels = unique(target))) # Ensure correct ordering
    
    if(nrow(filtered_data) > 0) {
      ggplot(filtered_data, aes(x = target, y = kd_apparent)) +
        geom_col() +
        coord_flip() + # Make the bar graph horizontal
        theme_minimal() +
        labs(x = "Target", y = "Kd (nM)", title = paste("Kd values for", input$selectedDrug)) +
        theme(axis.text.x = element_text(angle = 45, hjust = 1))
    } else {
      print("No data available for the selected criteria.")
    }
  })
  
  # Bar graph for Target to Drug
  output$barGraphTarget <- renderPlot({
    filtered_data <- combined_dataset_kinase_compound_info %>%
      filter(target == input$selectedTarget, kd_apparent < input$kdThresholdTarget) %>%
      arrange(desc(kd_apparent)) %>%
      mutate(compound = factor(compound, levels = unique(compound))) # Ensure correct ordering
    
    if(nrow(filtered_data) > 0) {
      ggplot(filtered_data, aes(x = compound, y = kd_apparent)) +
        geom_col() +
        coord_flip() + # Make the bar graph horizontal
        theme_minimal() +
        labs(x = "Compound", y = "Kd (nM)", title = paste("Drugs targeting", input$selectedTarget)) +
        theme(axis.text.x = element_text(angle = 45, hjust = 1))
    } else {
      print("No data available for the selected criteria.")
    }
  })
}

# Run the app
shinyApp(ui = ui, server = server)

```