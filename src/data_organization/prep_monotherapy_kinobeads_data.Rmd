---
title: "Prep PRISM with new kinobeads data for ML"
author: "Chinmaya Joisa"
date: "`r Sys.Date()`"
output: github_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(here)
library(fst)
library(vroom)
library(webchem)
library(clusterProfiler)

knitr::opts_knit$set(root.dir = here())
```

```{r}

kinobeads_data = read_fst(here("results/combined_dose_data_summarized_no_okl.fst"))  %>%
	mutate(compound_dose_M  = as.numeric(as.character(compound_dose_M)))  %>% 
	mutate(compound_dose_uM = compound_dose_M * 10^6)  %>%
	select(-compound_dose_M)

PRISM_drug_info = read_csv(here('data/PRISM/secondary/secondary-screen-replicate-treatment-info.csv'))

PRISM_cids = read_csv(here('data/matching/PRISM_cids.csv'))  %>% 
    mutate(cid = as.character(cid))

response_curve_parameters_full = vroom(here('data/PRISM/secondary/secondary-screen-dose-response-curve-parameters.csv'))

```

## Find matches between PRISM and kinobeads data

```{r}
compound_match_list = kinobeads_data %>%
    select(compound_pubchem_cid, compound_pubchem_title) %>%
    inner_join(PRISM_cids, by=c('compound_pubchem_cid' = 'cid')) %>%
    left_join(PRISM_drug_info %>% select(broad_id, name), by=c('query' = 'name'))  %>% 
    distinct()
```

OK, so none of the concentrations used in the screening data match with the concentrations used in Klaeger. Fortunately, PRISM provides log logistic fits for all of the viability curves, so we'll use these curve fits to impute all the viability values at the Klaeger concentrations.

The fitting methods used an R package named drc, which is described in this paper (https://doi.org/10.1371/journal.pone.0146021). Formula number 2 is used below to impute the viability values.

https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0146021#pone.0146021.e008

```{r}

doses = kinobeads_data %>%
	select(compound_dose_uM) %>%
	distinct()  %>% 
	filter(compound_dose_uM > 0)

broad_id_kinobeads_conc = crossing('broad_id' = compound_match_list$broad_id, 
																 'kinobeads_conc' = unique(doses))


#Filtering data to remove lower limit values above 1.0
PRISM_kinobeads_data = response_curve_parameters_full %>%
	left_join(broad_id_kinobeads_conc) %>%
	filter(lower_limit <= 1) %>%
	#These curves seem to be originally fit in uM concentrations, so we'll convert
	#the M concentration values to uM
	mutate(imputed_viability = lower_limit + (upper_limit - lower_limit)/(1 + exp(slope * (log(kinobeads_conc*10^6) - log(ec50))))) %>%
	select(broad_id,depmap_id,kinobeads_conc,imputed_viability) %>%
	inner_join(compound_match_list %>% select(broad_id,compound_pubchem_title, compound_pubchem_cid)) %>%
	group_by(depmap_id, broad_id, compound_pubchem_title, compound_pubchem_cid, kinobeads_conc) %>%
	summarise(imputed_viability = mean(imputed_viability)) %>%
		mutate(imputed_viability = case_when(
		imputed_viability < 0 ~ 0,
		TRUE ~ imputed_viability
	)) %>%
	ungroup()  %>%
	drop_na()  %>%  
	write_fst(here('results/PRISM_kinobeads_imputed_tidy.fst'))
```

