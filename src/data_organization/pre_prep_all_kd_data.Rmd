```{r setup, include=FALSE}
library(tidyverse)
library(here)
library(webchem)
library(clusterProfiler)
library(org.Hs.eg.db)
library(dplyr)
library(conflicted)
conflicts_prefer(select::dplyr)
conflicts_prefer(clusterProfiler::select)
conflicts_prefer(clusterProfiler::rename)
conflicts_prefer(clusterProfiler::filter)
conflicts_prefer(base::setdiff)
```

# processing kuster data
```{r}
kuster <- read_csv(here("data/new_kuster_data/kds.csv"))
kuster_compound_info_tool = read_csv(here("data/new_kuster_data/compound_info.csv"))
kuster_compound_info_clinical = read_csv(here("data/new_kuster_data/compound_info_clinical.csv"))

kuster_compound_info = bind_rows(kuster_compound_info_tool, kuster_compound_info_clinical  %>% rename(Compound = Drug))  %>% 
    select(Compound, SMILES)

kuster_processed = kuster  %>% 
    rename(Kinase = `Gene name`, Kd = `apparent Kd`)  %>% 
    left_join(kuster_compound_info, by = "Compound")  %>% 
    select(Kinase, Compound, SMILES, Kd) %>%
    filter(!is.na(Kd))
```

# processing klaeger data
```{r}
klaeger_processed = read_csv(here("data/klaeger_data/apparent_kd_values.csv"))  %>% 
    select(Compound = Drug, Kinase = Target, Kd = At)
```

# processing LINCS data
```{r}

kinomescan_protein_info = read_csv(here("data/okl_profiling_data/eurofins_kinase_info.csv"))

LINCS_processed = read_csv(here("data/LINCS_data/LINCS_KINOMEscan_Kd.csv"))  %>% 
    select(Kinase = `Protein Name`, Compound = `Small Molecule Name`, Kd)  %>% 
    filter(!is.na(Kd))  %>% 
    left_join(kinomescan_protein_info  %>% select(`DiscoveRx Gene Symbol`, `Entrez Gene Symbol`), by = c("Kinase" = "DiscoveRx Gene Symbol"))  %>%
    rename(entrez_gene_symbol = `Entrez Gene Symbol`) 

```

# processing OKL data
```{r}
okl_processed = read_csv(here("data/okl_profiling_data/okl_eurofins_pseudo_ic50.csv")) %>% 
    select(Kinase = `DiscoveRx Gene Symbol`, Compound = name, Kd = pseudo_ic50, entrez_gene_symbol = `Entrez Gene Symbol`)
```

# Use bitr to convert gene symbols to entrez gene ids for all datasets
```{r}
kuster_entrez = bitr(kuster_processed$Kinase, fromType = "SYMBOL", toType = "ENTREZID", OrgDb = org.Hs.eg.db)

kuster_processed_entrez = kuster_processed  %>% 
    left_join(kuster_entrez, by = c("Kinase" = "SYMBOL"))  %>% 
    select(Kinase, Compound, SMILES, Kd, ENTREZID)

klaeger_entrez = bitr(klaeger_processed$Kinase, fromType = "SYMBOL", toType = "ENTREZID", OrgDb = org.Hs.eg.db)

klaeger_processed_entrez = klaeger_processed  %>% 
    left_join(klaeger_entrez, by = c("Kinase" = "SYMBOL"))  %>% 
    select(Kinase, Compound, Kd, ENTREZID)

LINCS_entrez = bitr(LINCS_processed$entrez_gene_symbol, fromType = "SYMBOL", toType = "ENTREZID", OrgDb = org.Hs.eg.db)

LINCS_processed_entrez = LINCS_processed  %>% 
    left_join(LINCS_entrez, by = c("entrez_gene_symbol" = "SYMBOL"))  %>% 
    select(Kinase, Compound, Kd, ENTREZID)

okl_entrez = bitr(okl_processed$entrez_gene_symbol, fromType = "SYMBOL", toType = "ENTREZID", OrgDb = org.Hs.eg.db)

okl_processed_entrez = okl_processed  %>% 
    left_join(okl_entrez, by = c("entrez_gene_symbol" = "SYMBOL"))  %>% 
    select(Kinase, Compound, Kd, ENTREZID)

```

# Use webchem to get CIDs for all datasets
```{r}
kuster_cid = get_cid(unique(kuster_processed_entrez$SMILES), from = "SMILES", domain = "compound", match = "all", verbose = T) %>%
 	rename("kuster_name" = query)

write_csv(kuster_cid, here("data/matching/kuster_cids.csv"))

kuster_entrez_cid = kuster_processed_entrez  %>% 
    left_join(kuster_cid, by = c("SMILES" = "kuster_name"))  %>% 
    select(Kinase, Compound, SMILES, Kd, ENTREZID, cid)

klaeger_cids = read_csv(here("data/matching/klaeger_cids.csv"))  %>% 
    mutate(cid = as.character(cid))

klaeger_entrez_cid = klaeger_processed_entrez  %>% 
    left_join(klaeger_cids, by = c("Compound" = "klaeger_name"))  %>% 
    select(Kinase, Compound, Kd, ENTREZID, cid)

LINCS_cids = read_csv(here("data/matching/all_LINCS_cids.csv"))  %>% 
    mutate(cid = as.character(cid))

LINCS_entrez_cid = LINCS_processed_entrez  %>% 
    left_join(LINCS_cids, by = c("Compound" = "LINCS_name"))  %>% 
    select(Kinase, Compound, Kd, ENTREZID, cid)

okl_cids = get_cid(unique(okl_processed_entrez$Compound), from = "name", domain = "compound", match = "all", verbose = T) %>%
 	rename("okl_name" = query)

write_csv(okl_cids, here("data/matching/okl_cids.csv"))

okl_entrez_cid = okl_processed_entrez  %>% 
    left_join(okl_cids, by = c("Compound" = "okl_name"))  %>% 
    select(Kinase, Compound, Kd, ENTREZID, cid)

```

# Combine all datasets
```{r}
combined_dataset = bind_rows(kuster_entrez_cid, klaeger_entrez_cid, LINCS_entrez_cid, okl_entrez_cid)  %>%  
    select(Kinase, Compound, Kd, ENTREZID, cid, SMILES)
```